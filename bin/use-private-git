#!/usr/bin/env bash
#
# use-private-git: Enhanced private gitconfig management for repositories
#
# This script manages private git configurations for repositories, supporting
# multiple profiles and automatic detection of work vs personal repositories.
#
# Usage: use-private-git [options]

set -euo pipefail

# Default values
FORCE=false
REMOVE=false
PROFILE="default"
STATUS=false
AUTO_DETECT=false

# Show usage
show_usage() {
    echo "Usage: $0 [options]"
    echo ""
    echo "Manage private git configurations for repositories"
    echo ""
    echo "Options:"
    echo "  --force              Skip confirmation prompts"
    echo "  --remove             Remove private git configuration"
    echo "  --profile PROFILE    Use specific profile (default: 'default')"
    echo "  --status             Show current configuration status"
    echo "  --auto-detect        Auto-detect work vs personal repository"
    echo "  -h, --help           Show this help message"
    echo ""
    echo "Examples:"
    echo "  $0                   # Link default private config"
    echo "  $0 --profile work    # Use work profile"
    echo "  $0 --status          # Show current configuration"
    echo "  $0 --remove          # Remove private configuration"
    echo "  $0 --auto-detect     # Auto-detect repository type"
}

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --force|-f)
            FORCE=true
            shift
            ;;
        --remove)
            REMOVE=true
            shift
            ;;
        --profile)
            if [[ -z "${2:-}" ]]; then
                echo "‚ùå Error: --profile requires a profile name" >&2
                exit 1
            fi
            PROFILE="$2"
            shift 2
            ;;
        --status)
            STATUS=true
            shift
            ;;
        --auto-detect)
            AUTO_DETECT=true
            shift
            ;;
        -h|--help)
            show_usage
            exit 0
            ;;
        *)
            echo "‚ùå Error: Unknown option '$1'" >&2
            show_usage
            exit 1
            ;;
    esac
done

# Check if we're in a git repository
if ! git rev-parse --git-dir >/dev/null 2>&1; then
    echo "‚ùå Error: Not in a git repository" >&2
    exit 1
fi

# Get the git directory (handles both normal repos and worktrees)
GIT_DIR=$(git rev-parse --git-dir)
LOCAL_GITCONFIG="$GIT_DIR/config"

# Function to show current status
show_status() {
    echo "üìÑ Git Configuration Status"
    echo "=========================="
    echo "Repository: $(pwd)"
    echo "Git directory: $GIT_DIR"
    echo ""
    
    if [[ -L "$LOCAL_GITCONFIG" ]]; then
        echo "üîó Configuration: Symlinked"
        echo "Target: $(readlink "$LOCAL_GITCONFIG")"
    elif [[ -f "$LOCAL_GITCONFIG" ]]; then
        echo "üìÑ Configuration: Local file"
    else
        echo "‚ö†Ô∏è  Configuration: Not found"
    fi
    
    echo ""
    echo "Current user configuration:"
    echo "  user.name: $(git config user.name 2>/dev/null || echo '(not set)')"
    echo "  user.email: $(git config user.email 2>/dev/null || echo '(not set)')"
    
    # Show remote information
    if git remote get-url origin >/dev/null 2>&1; then
        remote_url=$(git remote get-url origin)
        echo "  remote.origin.url: $remote_url"
    fi
    
    return 0
}

# Auto-detect repository type
auto_detect_profile() {
    local remote_url
    if remote_url=$(git remote get-url origin 2>/dev/null); then
        # Check common work domain patterns
        if [[ "$remote_url" =~ (github\.com[:/][^/]+/[^/]+|gitlab\.com[:/][^/]+/[^/]+) ]]; then
            # Extract organization/user from URL
            if [[ "$remote_url" =~ github\.com[:/]([^/]+)/ ]]; then
                org="${BASH_REMATCH[1]}"
                # Add your work organizations here
                case "$org" in
                    "spotify"|"company"|"work-org")
                        echo "work"
                        return
                        ;;
                esac
            fi
        fi
        # Check for work-specific patterns in URL
        if [[ "$remote_url" =~ (corp|company|work|enterprise) ]]; then
            echo "work"
            return
        fi
    fi
    
    # Default to personal
    echo "personal"
}

# Handle status command
if $STATUS; then
    show_status
    exit 0
fi

# Auto-detect profile if requested
if $AUTO_DETECT; then
    detected_profile=$(auto_detect_profile)
    echo "ü§ñ Auto-detected profile: $detected_profile"
    PROFILE="$detected_profile"
fi

# Find private gitconfig based on profile
if [[ "$PROFILE" == "default" ]]; then
    PRIVATE_GITCONFIG="$HOME/repos/dotfiles/git/.gitconfig.private"
else
    PRIVATE_GITCONFIG="$HOME/repos/dotfiles/git/.gitconfig.private.$PROFILE"
fi

# Handle remove command
if $REMOVE; then
    if [[ -L "$LOCAL_GITCONFIG" ]]; then
        rm "$LOCAL_GITCONFIG"
        echo "‚úÖ Private gitconfig symlink removed"
        
        # Restore backup if it exists
        if [[ -f "${LOCAL_GITCONFIG}.backup" ]]; then
            mv "${LOCAL_GITCONFIG}.backup" "$LOCAL_GITCONFIG"
            echo "üîÑ Restored backup configuration"
        fi
    else
        echo "‚ö†Ô∏è  No private gitconfig symlink to remove"
    fi
    show_status
    exit 0
fi

# Check if private gitconfig exists
if [[ ! -f "$PRIVATE_GITCONFIG" ]]; then
    echo "‚ùå Error: Private gitconfig not found at $PRIVATE_GITCONFIG" >&2
    echo "Available profiles:" >&2
    find "$HOME/repos/dotfiles/git" -name ".gitconfig.private*" -maxdepth 1 2>/dev/null | sed 's/.*\.gitconfig\.private/  /' | sed 's/^  $/  default/' || echo "  No private configs found" >&2
    exit 1
fi

# Validate git config syntax
if ! git config -f "$PRIVATE_GITCONFIG" --list >/dev/null 2>&1; then
    echo "‚ùå Error: Invalid git configuration syntax in $PRIVATE_GITCONFIG" >&2
    exit 1
fi

# Check if local config already exists and is not a symlink
if [[ -f "$LOCAL_GITCONFIG" && ! -L "$LOCAL_GITCONFIG" ]]; then
    if [[ "$FORCE" == "false" ]]; then
        echo "‚ö†Ô∏è  Warning: Local git config exists and is not a symlink"
        echo "Current config: $LOCAL_GITCONFIG"
        echo "This will backup the existing config to ${LOCAL_GITCONFIG}.backup"
        read -p "Continue? [y/N] " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "‚ùå Aborted"
            exit 1
        fi
    fi
    mv "$LOCAL_GITCONFIG" "${LOCAL_GITCONFIG}.backup"
    echo "üíæ Backed up existing config to ${LOCAL_GITCONFIG}.backup"
fi

# Remove existing symlink if it exists
if [[ -L "$LOCAL_GITCONFIG" ]]; then
    rm "$LOCAL_GITCONFIG"
fi

# Create the symlink
ln -sf "$PRIVATE_GITCONFIG" "$LOCAL_GITCONFIG"

echo "‚úÖ Private gitconfig linked successfully"
echo "Profile: $PROFILE"
echo "Target: $PRIVATE_GITCONFIG"
echo ""

# Show current user configuration
show_status