#!/usr/bin/env bash
if ( ! hash yq ) ; then
  echo "You need to have yq installed for this command to work. Install it via Homebrew/Linuxbrew, since the one provided with pip/apt has compatibiliby issues."
  exit 1
fi
if ( ! hash kubectl-site ) ; then
  echo "You need kubectl-site installed. Install manually from GHE:shared/spotify-taps or install this script from Homebrew"
  exit 1
fi
if [[ ! -e kubernetes/deployment.yaml ]]; then
  echo "No kubernetes/deployment.yaml file found. Please cd to root of the git project you want to get logs for."
  exit 1
fi

#Read deployment info from Spotify kubernetes files
namespace=$(yq r kubernetes/service.yaml metadata.namespace)
container=$(yq r kubernetes/deployment.yaml spec.template.spec.containers[0].name)
app=$(yq r kubernetes/service.yaml metadata.labels.app)

#Check if the installationId is overridden in build-info.yaml
#and if so use that
installation=$(yq r build-info.yaml template.javaBackend.deployments.\[\*\].services\[\*\].tugboat.installationId | sed -e 's/- //g')

if [[ $installation == "null" || $installation == "" ]]; then
  kubectl site $app
else
  kubectl site $installation
fi

kubectl logs -l app=$app --namespace=$namespace -c $container --since=1h ${1:-}

